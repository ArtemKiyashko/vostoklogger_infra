trigger:
  branches:
    include:
      - main
  paths:
    include:
      - '*.bicep'
      - '*.bicepparam'

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: 'Azure-ServiceConnection'
  resourceGroupName: 'rsgweprivate-vostoklogger'
  location: 'westeurope'

stages:
  - stage: Validate
    displayName: 'Validate Bicep'
    jobs:
      - job: ValidateBicep
        displayName: 'Validate Bicep'
        steps:
          - task: AzureCLI@2
            displayName: 'Build and Validate'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az bicep build --file main.bicep
                az deployment group validate \
                  --resource-group $(resourceGroupName) \
                  --template-file main.bicep \
                  --parameters main.bicepparam

  - stage: Deploy
    displayName: 'Deploy Infrastructure'
    dependsOn: Validate
    jobs:
      - job: DeployInfra
        displayName: 'Deploy'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Bicep'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az group create --name $(resourceGroupName) --location $(location)
                
                # Получить текущий образ Container App если она существует
                CURRENT_IMAGE=$(az containerapp show \
                  --name vostoklogger-mqtt \
                  --resource-group $(resourceGroupName) \
                  --query 'properties.template.containers[0].image' \
                  -o tsv 2>/dev/null || echo "")
                
                # Если Container App существует и образ не placeholder, использовать его
                if [ ! -z "$CURRENT_IMAGE" ] && [[ "$CURRENT_IMAGE" != *"containerapps-helloworld"* ]]; then
                  echo "Сохраняем текущий образ: $CURRENT_IMAGE"
                  az deployment group create \
                    --resource-group $(resourceGroupName) \
                    --template-file main.bicep \
                    --parameters main.bicepparam mqttFilterImage="$CURRENT_IMAGE"
                else
                  echo "Используем placeholder образ для первого деплоя"
                  az deployment group create \
                    --resource-group $(resourceGroupName) \
                    --template-file main.bicep \
                    --parameters main.bicepparam
                fi
